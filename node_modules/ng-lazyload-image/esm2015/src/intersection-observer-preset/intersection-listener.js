import { empty, Observable, Subject } from 'rxjs';
import { filter } from 'rxjs/operators';
import { isWindowDefined } from '../util';
const observers = new WeakMap();
const intersectionSubject = new Subject();
function loadingCallback(entrys) {
    entrys.forEach(entry => intersectionSubject.next(entry));
}
export const getIntersectionObserver = (attributes) => {
    if (!attributes.scrollContainer && !isWindowDefined()) {
        return empty();
    }
    const options = {
        root: attributes.scrollContainer
    };
    if (attributes.offset) {
        options.rootMargin = `${attributes.offset}px`;
    }
    const scrollContainer = attributes.scrollContainer || window;
    let observer = observers.get(scrollContainer);
    if (!observer) {
        observer = new IntersectionObserver(loadingCallback, options);
        observers.set(scrollContainer, observer);
    }
    observer.observe(attributes.element);
    return Observable.create((obs) => {
        const subscription = intersectionSubject.pipe(filter(entry => entry.target === attributes.element)).subscribe(obs);
        return () => {
            subscription.unsubscribe();
            observer.unobserve(attributes.element);
        };
    });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW50ZXJzZWN0aW9uLWxpc3RlbmVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmctbGF6eWxvYWQtaW1hZ2UvIiwic291cmNlcyI6WyJzcmMvaW50ZXJzZWN0aW9uLW9ic2VydmVyLXByZXNldC9pbnRlcnNlY3Rpb24tbGlzdGVuZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2xELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUV4QyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBTzFDLE1BQU0sU0FBUyxHQUFHLElBQUksT0FBTyxFQUFzQyxDQUFDO0FBRXBFLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxPQUFPLEVBQTZCLENBQUM7QUFFckUsU0FBUyxlQUFlLENBQUMsTUFBbUM7SUFDMUQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0FBQzNELENBQUM7QUFFRCxNQUFNLENBQUMsTUFBTSx1QkFBdUIsR0FBRyxDQUFDLFVBQXNCLEVBQXlDLEVBQUU7SUFDdkcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxlQUFlLElBQUksQ0FBQyxlQUFlLEVBQUUsRUFBRTtRQUNyRCxPQUFPLEtBQUssRUFBRSxDQUFDO0tBQ2hCO0lBRUQsTUFBTSxPQUFPLEdBQW9CO1FBQy9CLElBQUksRUFBRSxVQUFVLENBQUMsZUFBZTtLQUNqQyxDQUFDO0lBQ0YsSUFBSSxVQUFVLENBQUMsTUFBTSxFQUFFO1FBQ3JCLE9BQU8sQ0FBQyxVQUFVLEdBQUcsR0FBRyxVQUFVLENBQUMsTUFBTSxJQUFJLENBQUM7S0FDL0M7SUFFRCxNQUFNLGVBQWUsR0FBRyxVQUFVLENBQUMsZUFBZSxJQUFJLE1BQU0sQ0FBQztJQUU3RCxJQUFJLFFBQVEsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBRTlDLElBQUksQ0FBQyxRQUFRLEVBQUU7UUFDYixRQUFRLEdBQUcsSUFBSSxvQkFBb0IsQ0FBQyxlQUFlLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDOUQsU0FBUyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEVBQUUsUUFBUSxDQUFDLENBQUM7S0FDMUM7SUFFRCxRQUFRLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUVyQyxPQUFPLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUF1QyxFQUFFLEVBQUU7UUFDbkUsTUFBTSxZQUFZLEdBQUcsbUJBQW1CLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxNQUFNLEtBQUssVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ25ILE9BQU8sR0FBRyxFQUFFO1lBQ1YsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQzNCLFFBQVMsQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzFDLENBQUMsQ0FBQztJQUNKLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZW1wdHksIE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEF0dHJpYnV0ZXMgfSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQgeyBpc1dpbmRvd0RlZmluZWQgfSBmcm9tICcuLi91dGlsJztcblxudHlwZSBPYnNlcnZlck9wdGlvbnMgPSB7XG4gIHJvb3Q/OiBFbGVtZW50O1xuICByb290TWFyZ2luPzogc3RyaW5nO1xufTtcblxuY29uc3Qgb2JzZXJ2ZXJzID0gbmV3IFdlYWtNYXA8RWxlbWVudCB8IHt9LCBJbnRlcnNlY3Rpb25PYnNlcnZlcj4oKTtcblxuY29uc3QgaW50ZXJzZWN0aW9uU3ViamVjdCA9IG5ldyBTdWJqZWN0PEludGVyc2VjdGlvbk9ic2VydmVyRW50cnk+KCk7XG5cbmZ1bmN0aW9uIGxvYWRpbmdDYWxsYmFjayhlbnRyeXM6IEludGVyc2VjdGlvbk9ic2VydmVyRW50cnlbXSkge1xuICBlbnRyeXMuZm9yRWFjaChlbnRyeSA9PiBpbnRlcnNlY3Rpb25TdWJqZWN0Lm5leHQoZW50cnkpKTtcbn1cblxuZXhwb3J0IGNvbnN0IGdldEludGVyc2VjdGlvbk9ic2VydmVyID0gKGF0dHJpYnV0ZXM6IEF0dHJpYnV0ZXMpOiBPYnNlcnZhYmxlPEludGVyc2VjdGlvbk9ic2VydmVyRW50cnk+ID0+IHtcbiAgaWYgKCFhdHRyaWJ1dGVzLnNjcm9sbENvbnRhaW5lciAmJiAhaXNXaW5kb3dEZWZpbmVkKCkpIHtcbiAgICByZXR1cm4gZW1wdHkoKTtcbiAgfVxuXG4gIGNvbnN0IG9wdGlvbnM6IE9ic2VydmVyT3B0aW9ucyA9IHtcbiAgICByb290OiBhdHRyaWJ1dGVzLnNjcm9sbENvbnRhaW5lclxuICB9O1xuICBpZiAoYXR0cmlidXRlcy5vZmZzZXQpIHtcbiAgICBvcHRpb25zLnJvb3RNYXJnaW4gPSBgJHthdHRyaWJ1dGVzLm9mZnNldH1weGA7XG4gIH1cblxuICBjb25zdCBzY3JvbGxDb250YWluZXIgPSBhdHRyaWJ1dGVzLnNjcm9sbENvbnRhaW5lciB8fCB3aW5kb3c7XG5cbiAgbGV0IG9ic2VydmVyID0gb2JzZXJ2ZXJzLmdldChzY3JvbGxDb250YWluZXIpO1xuXG4gIGlmICghb2JzZXJ2ZXIpIHtcbiAgICBvYnNlcnZlciA9IG5ldyBJbnRlcnNlY3Rpb25PYnNlcnZlcihsb2FkaW5nQ2FsbGJhY2ssIG9wdGlvbnMpO1xuICAgIG9ic2VydmVycy5zZXQoc2Nyb2xsQ29udGFpbmVyLCBvYnNlcnZlcik7XG4gIH1cblxuICBvYnNlcnZlci5vYnNlcnZlKGF0dHJpYnV0ZXMuZWxlbWVudCk7XG5cbiAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnM6IFN1YmplY3Q8SW50ZXJzZWN0aW9uT2JzZXJ2ZXJFbnRyeT4pID0+IHtcbiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSBpbnRlcnNlY3Rpb25TdWJqZWN0LnBpcGUoZmlsdGVyKGVudHJ5ID0+IGVudHJ5LnRhcmdldCA9PT0gYXR0cmlidXRlcy5lbGVtZW50KSkuc3Vic2NyaWJlKG9icyk7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIHN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgb2JzZXJ2ZXIhLnVub2JzZXJ2ZShhdHRyaWJ1dGVzLmVsZW1lbnQpO1xuICAgIH07XG4gIH0pO1xufTtcbiJdfQ==